<div class="layout-row layout-align-space-between-center">
  <div class="layout-row layout-align-start-center">
    <h2>
      {{#if editMode}}Bewerk details{{else}}Overzicht{{/if}} offerte {{model.number}}
    </h2>
    {{#if editMode}}
      <SaveStatusIcon @model={{model}} @task={{save}} />
    {{/if}}
  </div>
  <div>
    {{#if editMode}}
      {{#if isEnabledDelete}}
        <PaperButton @onClick={{perform remove}} @iconButton={{true}}>
          {{paper-icon "delete"}}
          <PaperTooltip>Verwijderen</PaperTooltip>
        </PaperButton>
      {{/if}}
      <PaperButton @onClick={{action "closeEdit"}} @iconButton={{true}}>
        {{paper-icon "exit to app"}}
        <PaperTooltip>Sluiten</PaperTooltip>
      </PaperButton>
    {{else}}
      <PaperButton @onClick={{action "openEdit"}} @iconButton={{true}} @disabled={{isDisabledEdit}}>
        {{paper-icon "edit mode"}}
        <PaperTooltip>Aanpassen</PaperTooltip>
      </PaperButton>
    {{/if}}
  </div>
</div>

{{#if hasOrder}}
  <WarningMessage @message="Reeds besteld. Geen wijzigingen meer mogelijk." />
{{else if model.isMasteredByAccess}}
  <WarningMessage @message="De offerte is aangemaakt in Access en kan hier niet gewijzigd worden." />
{{else if hasMixedVatRates}}
  <InfoMessage @message="De offerte bevat items met verschillende BTW tarieven. Hier kan geen bestelling voor opgesteld worden." />
{{/if}}

{{#if remove.isRunning}}
  <div>
    <PaperProgressLinear />
    <p>Aan het verwijderen...</p>
  </div>
{{else if rollbackTree.isRunning}}
  <div>
    <PaperProgressLinear />
    <p>Aan het herstellen...</p>
  </div>
{{else if (and (not model.id) model.isSavivg)}}
  <div>
    <PaperProgressLinear />
    <p>Aan het aanmaken...</p>
  </div>
{{else}}
  {{#if editMode}}
    <OfferEditForm @model={{model}} @save={{save}} />
  {{else}}
    <OfferDetailPanel @model={{model}} />
  {{/if}}

  {{#if model.isMasteredByAccess}}
    <h2>Offerte</h2>
    <p class="note-message">De offerte is aangemaakt in Access. De inhoud kan hier niet weergegeven worden.</p>
  {{else}}
    <div class="layout-row layout-align-space-between-center">
      <h2>Offerte
        <span class="small-text-fade">[
          {{#if editMode}}
            <Input @value={{model.documentVersion}} @key-up={{action (mut model.documentVersion)}} @focus-out={{perform save}} class="xsmall" />
            <PaperTooltip>
              Pas het versienummer aan om een nieuwe versie van het document te maken; anders wordt het vorige document overschreven.
            </PaperTooltip>
          {{else}}
            {{model.documentVersion}}
          {{/if}}
          ]
        </span>
      </h2>
      <div>
        {{#if generateOfferDocument.isRunning}}
          <PaperProgressCircular @diameter={{18}} />
        {{else}}
          {{#unless editMode}}
            <PaperButton @onClick={{action "downloadOfferDocument"}} @iconButton={{true}}>
              {{paper-icon "find in page"}}
              <PaperTooltip>Offerte bekijken</PaperTooltip>
            </PaperButton>
          {{/unless}}
          {{#unless isDisabledEdit}}
            <PaperButton @onClick={{perform generateOfferDocument}} @iconButton={{true}}>
              {{paper-icon "restore page"}}
              <PaperTooltip>Offerte maken</PaperTooltip>
            </PaperButton>
          {{/unless}}
        {{/if}}
      </div>
    </div>

    {{#if editMode}}
      <div class="offer-document-form layout-column">
        <section>
          <label>Introductie</label>
          <PellEditor @class="pell-editor offer-intro" @value={{model.documentIntro}} @pellOptions={{pellOptions}} @onChange={{action (mut model.documentIntro)}} @focusOut={{perform save}} />
        </section>
        <section>
          <div class="layout-row layout-align-start-center">
            <label>Producten</label>
          </div>
          {{#each sortedOfferlines as |offerline|}}
            <OfferlineEditForm @model={{offerline}} @onDelete={{action "deleteOfferline"}} />
          {{else}}
            <div class="note note--info">Nog geen producten toegevoegd. Klik <span class="link-action" {{action "addOfferline"}}>hier</span> om producten toe te voegen aan de offerte.</div>
          {{/each}}
          <div class="layout-row layout-align-end-center">
            <div class="link-action" {{action "addOfferline"}}>{{paper-icon "add"}} Lijn toevoegen</div>
          </div>
        </section>
        <section>
          <label>Voorwaarden</label>
          <PellEditor @class="pell-editor offer-outro" @value={{model.documentOutro}} @pellOptions={{pellOptions}} @onChange={{action (mut model.documentOutro)}} @focusOut={{perform save}} />
        </section>
      </div>
  {{else}}
      <div class="offer-document layout-column">
        <section>{{{model.documentIntro}}}</section>
        <section><OfferlinesDetailPanel @model={{model.offerlines}} /></section>
        <section>{{{model.documentOutro}}}</section>
      </div>
    {{/if}}
  {{/if}}
{{/if}}

<UnsavedChangesDialog @show={{showUnsavedChangesDialog}} @onConfirm={{action "confirmCloseEdit"}} />
